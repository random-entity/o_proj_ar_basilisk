#include "cmd_rcvrs/neokey_cr.h"
#include "cmd_rcvrs/xbee_cr.h"
#include "components/specifics/neokey1x4_i2c0.h"
#include "components/specifics/neokey3x4_i2c0.h"
#include "executer.h"
#include "helpers/beat.h"
#include "helpers/teensyid.h"
#include "helpers/clamped.h"
#include "helpers/utils.h"
#include "rpl_sndrs/led_rs.h"
#include "rpl_sndrs/serial_rs.h"
#include "servo_units/basilisk.h"

// CommandReceivers.
XbeeCommandReceiver xb_cr;
Neokey& nk = specifics::neokey1x4_i2c0;
NeokeyCommandReceiver nk_cr{nk};

// ReplySenders.
XbeeReplySender xb_rs;

void setup() {
  xb_cr.Setup(&b);
  nk_cr.Setup(&b);
  xb_rs.Setup(&b);
  led_rs::suid = b.cfg_.suid;
  delay(250);
}

void loop() {
  b.Run();

  xb_cr.Run();
  xb_rs.Run();

  static Beat nk_cr_beat{10};
  if (nk_cr_beat.Hit()) nk_cr.Run();

  static Beat exec_beat{10};
  if (exec_beat.Hit()) exec.Run();

  static Beat led_rs_beat{1};
  if (led_rs_beat.Hit()) LedReplySender(nk);

  static Beat serial_rs_beat{500};
  if (serial_rs_beat.Hit()) SerialReplySender(b);
}
